Тестовое задание — Стажёр-разработчик Go (Клиентские сервисы)



Простое CRUD-приложение на языке Go (Golang), которое позволяет управлять сущностями: Пользователь, Пост и Комментарий.
Приложение реализует REST и GraphQL API, поддерживает пагинацию, валидацию данных и может быть развёрнуто в Docker вместе с базой данных PostgreSQL.

## Описание задачи
Реализовать систему для добавления и чтения постов и комментариев с использованием GraphQL,
аналогичную комментариям к постам на популярных платформах, таких как Хабр или Reddit.

## Описание проекта
Этот проект представляет собой REST API, которое позволяет:
- Создавать, читать, обновлять и удалять записи для сущностей:
    - **Пользователь** (User)
    - **Пост** (Post)
    - **Комментарий** (Comment)
    
- Работать через REST и GraphQL API.
- Хранить данные в базе данных PostgreSQL.
- Использовать Docker Compose для развёртывания приложения и базы данных.

### Характеристики системы постов:
- Можно просмотреть список постов.
- Можно просмотреть пост и комментарии под ним.
- Пользователь, написавший пост, может запретить оставление комментариев к своему посту.

### Характеристики системы комментариев к постам:
- Комментарии организованы иерархически, позволяя вложенность без ограничений.
- Длина текста комментария ограничена до, например, 2000 символов.
- Система пагинации для получения списка комментариев.


### Основные функции:
-	CRUD-операции для всех сущностей.
-	Пагинация (limit, lastID).
-	Валидация длины текста комментариев (1–2000 символов).
-	Возможность запрета комментариев к постам.
-	Простая и модульная структура (Clean Architecture).

## Установка и запуск

### Требования
- Установленный Go (версия 1.24 или выше).
- Docker для запуска в контейнере.

### Запуск проекта
1. Клонируйте репозиторий:
```bash
   git clone https://github.com/bezggod/posts_comments_service.git
   cd posts_comments_service
   ```
2. Установите зависимости:
   ```bash
   go mod download
   ```
3. Настройте файл .env (пример в docker.env) с параметрами подключения к базе данных PostgreSQL:
```bash
   ADDR=:8080
   STORAGE_MODE=postgres 
   POSTGRES_PG_DSN=postgres://bezgo:12345@localhost:5432/p_c_service?sslmode=disable
```
4.	Запустите PostgreSQL:
```bash
      make docker.run.db
````
5. Примените миграции:
```bash
make docker.run.migrate
````
6. Запустите сервер:
   ```bash
   go run main.go
   ```
Сервер будет доступен по адресу: `http://localhost:8080`.


### Запуск с помощью Docker
1. Соберите Docker-образ:
   ```bash
   docker build -t posts_comments_service .
   ```
2. Запустите контейнер:
   ```bash
   docker run -p 8080:8080 posts_comments_service
   ```
3. Или запустите всё через Docker Compose (приложение + база данных):
   ```bash
    docker compose up -d
   ```

## Использование

### API

#### Пользователь (User)
- **Создание пользователя:**
    - **Метод:** `POST`
    - **URL:** `/users`
    - **Тело запроса:**
      ```json
      {
          "name": "Danila"
      }
      ```
- **Получение пользователя по ID:**
    - **Метод:** `GET`
    - **URL:** `/users/{id}`

#### Пост (Post)
- **Создание поста:**
    - **Метод:** `POST`
    - **URL:** `/post`
    - **Тело запроса:**
      ```json
      {
          "user_id": 1,
          "title": "GraphQL works",
          "body": "This is a test post",
          "comment_block": false
      }
      ```
- **Получение постов по ID:**
  - **Метод:** `GET`
  - **URL:** `/posts/{id}`

- **Пагинация постов:**
    - **Метод:** `Get`
    - **URL:** `/posts?limit=2&last=5`
    - **Тело запроса:**
      ```json
      {
          "next_id": 4,
          "posts": [
              {"ID": 5, "Title": "Post5"},
              {"ID": 4, "Title": "Post4"}
          ]
      }
      ```
#### Комментарий (Comment)
- **Создание корневого комментария:**
    - **Метод:** `POST`
    - **URL:** `/comments/root`
    - **Тело запроса:**
      ```json
      {
          "post_id": 1,
          "user_id": 1,
          "text": "root comment"
      }
      ```
- **Создание ответа на комментарий:**
  - **Метод:** `POST`
  - **URL:** `/comment/reply`
  - **Тело запроса:**
  ```json
  {
          "post_id": 1,
          "user_id": 1,
          "parent_comment_id": 3,
          "text": "root comment"
  }
  ```
**Получение комментариев по ID:**
- **Метод:** `GET`
- **URL:** `/comments/{id}`

**Список корневых комментариев:**
- **Метод:** `GET`
- **URL:** `/comments/roots?post_id=1&limit=10`

**Список ответов (тред):**
- **Метод:** `GET`
- **URL:** `comments/threads?post_id=1&first_comment_id=3`

#### Graphql API
API описано в `.graphqls` файлах в директории [`internal/graphql`](./internal/graphql).  
Запросы разделены по доменам: **пользователи (users)**, **посты (posts)** и **комментарии (comments)**.

Для тестирования сервиса можно воспользоваться **Postman** или любым GraphQL Playground.  
По умолчанию GraphQL Playground доступен по адресу: `http://localhost:8080/`.
Там можно выполнять Queries и Mutations прямо из браузера.  
Если удобнее использовать консоль — ниже приведены примеры.

Сервис построен на основе библиотеки [gqlgen](https://gqlgen.com/),  
которая используется для генерации GraphQL-схем и резолверов.

---

### Основные операции

#### Queries
- `getUser(id: Int!)` — получить пользователя по ID
- `getPost(id: Int!)` — получить пост по ID
- `listPosts(limit: Int, lastID: Int)` — список постов с пагинацией
- `listRoots(postID: Int!, limit: Int)` — список корневых комментариев
- `listThreads(postID: Int!, firstCommentID: Int!, limit: Int)` — дерево комментариев

#### Mutations
- `createUser(input: InputUser!)` — создать пользователя
- `createPost(input: InputPost!)` — создать пост
- `createComment(input: InputComment!)` — создать комментарий

---

### Примеры запросов

#### Получение списка постов
```graphql
{
  listPosts(limit: 2) {
    posts {
      id
      title
      body
      userID
    }
    nextID
  }
}
````

#### Получение поста и комментариев
```graphql
{
  getPost(id: 1) {
    id
    title
    body
    userID
  }
  listRoots(postID: 1, limit: 3) {
    id
    text
    userID
    replies {
      id
      text
    }
  }
}
```

#### Создание пользователя
```graphql
mutation {
  createUser(input: { name: "BezGo" }) {
    id
    name
  }
}
```
## Реализованный функционал

### Queries
Реализованы запросы GraphQL:
- `listPosts(limit, lastID)` — получение списка постов с пагинацией
- `getPost(id)` — получение подробной информации о посте
- `listRoots(postID, limit)` — получение корневых комментариев
- `listThreads(postID, firstCommentID, limit)` — получение ветки комментариев

Для оптимизации и избежания проблемы **N+1 запросов**, загрузка комментариев для поста или вложенных ответов выполняется только при их явном запросе в GraphQL-запросе.

---

### Mutations
Реализованы мутации:
- `createUser(input)` — создание пользователя
- `createPost(input)` — создание поста
- `createComment(input)` — создание комментария

При создании поста можно указать, разрешены ли к нему комментарии (`commentBlock = true/false`).  
Комментарий создаётся для конкретного поста и может быть:
- **корневым** — если `parentCommentID` не передан
- **ответом** — если указан `parentCommentID`

При создании комментария проверяется, можно ли к посту оставлять комментарии, а также длина текста (не более **2000 символов**).

---

### Тестирование
В проекте реализованы **unit-тесты** для слоя `usecase` (в частности, `comment_usecase`, `post_usecase`, `user_usecase`).  
Для создания моков используется утилита [mockery](https://github.com/vektra/mockery).  
Тесты покрывают логику:
- создания постов и комментариев,
- проверку ограничений (`commentBlock`, длина текста),
- корректное взаимодействие между репозиториями и usecase-слоем.

Запуск тестов:
```bash
    make tests.run
```
### Хранилище данных

Поддерживаются два типа хранилища:
- PostgreSQL — основное хранилище
- In-Memory — тестовое, используется для локального запуска и unit-тестов

Выбор задаётся переменной окружения STORAGE_MODE:
- STORAGE_MODE=postgres — PostgreSQL
- STORAGE_MODE=memory — In-Memory

В Docker по умолчанию используется PostgreSQL.

Для локального запуска можно изменить значение в .env.